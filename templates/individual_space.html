{% extends "base.html" %}

{% block title %}{{ space.name }} · BubblesBnB{% endblock %}

{% block content %}
  {# Flatpickr CSS (page-local). In HTML5 it's valid to include this here. #}
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
</head>
<body>
    <h1>{{ space.name }}</h1>
    <div class="spaces-listing">
        <p class="space-name">{{space.name}}</p>
        <p class="space-description">{{space.description}}</p>
        <p class="space-price-per-night">£{{ '%.2f'|format(space.price_per_night) }}</p>
        <p class="space-booking-flag">{{space.booking_flag}}</p>
        <p class="user-name">{{user.name}}</p>

  <div class="row g-4 align-items-start">
    <!-- Image -->
    <div class="col-12 col-lg-6">
      {# 
        Prefer user-uploaded image_path, otherwise fall back to a mock.
        IMPORTANT: space.image_path should be a path *relative* to /static,
        e.g. "uploads/space1.jpg" or "img/space1.jpg".
      #}
      {% if space.image_path %}
        {% set image_path = space.image_path %}
      {% else %}
        {% set image_path = 'img/mock-' ~ (((space.id or 1) - 1) % 4 + 1) ~ '.jpg' %}
      {% endif %}

      <img
        class="img-fluid rounded shadow-sm w-100"
        style="max-height: 360px; object-fit: cover;"
        src="{{ url_for('static', filename=image_path) }}"
        alt="{{ space.name }} photo"
        onerror="this.onerror=null;this.src='{{ url_for('static', filename='img/space-placeholder.jpg') }}';">
    </div>

    <!-- Details + booking -->
    <div class="col-12 col-lg-6">
      <h1 class="h3 mb-1">{{ space.name }}</h1>

      <div class="d-flex align-items-center gap-2 mb-3">
        <span class="fs-5">£{{ '%.2f'|format(space.price_per_night) }}</span>
        <span class="text-muted">/ night</span>
        {% if space.booked_flag %}
          <span class="badge text-bg-secondary">Booked</span>
        {% else %}
          <span class="badge text-bg-success">Available</span>
        {% endif %}
      </div>

      <p class="mb-3">{{ space.description }}</p>

      <p class="small text-muted mb-4">
        Host: {{ user.name or user.username }}
      </p>

      <!-- Booking form -->
      <div class="card shadow-sm">
        <div class="card-body">
          <h2 class="h5 mb-3">Select an available date</h2>
          <form action="{{ url_for('make_booking', id=space.id) }}" method="post" class="row g-3">
            <div class="col-12 col-md-8">
              <input
                id="datepicker"
                name="datepicker"
                type="text"
                class="form-control"
                placeholder="Choose a date"
                required>
            </div>
            <div class="col-12 col-md-4 d-grid">
              <button id="booking-btn" type="submit" class="btn btn-primary">Book this space</button>
            </div>
          </form>
          <div class="form-text mt-2">Only available dates can be selected.</div>
        </div>
      </div>

      <div class="mt-3">
        <a class="btn btn-outline-secondary" href="{{ url_for('get_spaces') }}">Back to all spaces</a>
      </div>
    </div>
  </div>

  <!-- Flatpickr JS (page-local) -->
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <script>
    const availableDates = {{ dates | tojson }};
    flatpickr("#datepicker", {
      dateFormat: "Y-m-d",
      enable: availableDates,     // only allow these dates
      minDate: "today",
      disableMobile: true,
      altInput: true,
      altFormat: "F j, Y",
      allowInput: true
    });
  </script>
{% endblock %}
